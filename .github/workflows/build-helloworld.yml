name: Build OpenWrt Packages

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch: # 支持手动触发
  pull_request:
    paths-ignore:
      - '**.md'

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            target: x86-64

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine branch name
        run: |
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            BRANCH="${GITHUB_BASE_REF#refs/heads/}"
          else
            BRANCH="${GITHUB_REF#refs/heads/}"
          fi
          echo "Building for $BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      # === 新：构建全部插件（可根据需要指定目录） ===
      - name: Build all packages
        uses: immortalwrt/gh-action-sdk@v7
        env:
          ARCH: ${{ matrix.arch }}
          FEEDNAME: packages_ci
          V: s
          target: ${{ matrix.target }}
          packages: "" # 空表示全部 feed 下插件

      - name: Move created packages to release dir
        run: |
          mkdir -p release/${{ matrix.arch }}
          find bin/packages/${{ matrix.arch }}/packages_ci -name "*.ipk" -exec cp {} release/${{ matrix.arch }}/ \; || true

      - name: Collect metadata
        run: |
          MERGE_ID=$(git rev-parse --short HEAD)
          
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            BASE_ID=$(git rev-parse --short origin/$BRANCH)
            HEAD_ID=$(git rev-parse --short HEAD)
            PRNUMBER=${GITHUB_REF_NAME%/merge}
          else
            BASE_ID=$(git rev-parse --short HEAD^)
            HEAD_ID=$MERGE_ID
            PRNUMBER="push-$MERGE_ID"
          fi
          
          echo "MERGE_ID=$MERGE_ID" >> $GITHUB_ENV
          echo "BASE_ID=$BASE_ID" >> $GITHUB_ENV
          echo "HEAD_ID=$HEAD_ID" >> $GITHUB_ENV
          echo "PRNUMBER=$PRNUMBER" >> $GITHUB_ENV
          echo "ARCHIVE_NAME=${{ matrix.arch }}-$PRNUMBER" >> $GITHUB_ENV

      - name: Generate metadata
        run: |
          shopt -s nullglob
          IPKS=( release/${{ matrix.arch }}/*.ipk )
          
          cat << EOF > release/${{ matrix.arch }}/PKG-INFO
          Metadata-Version: 2.1
          Name: ${{ env.ARCHIVE_NAME }}
          Version: $BRANCH
          Author: $GITHUB_ACTOR
          Home-page: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY
          Download-URL: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
          Summary: All packages from feed $FEEDNAME
          Platform: ${{ matrix.arch }}

          Packages for ImmortalWrt $BRANCH running on ${{ matrix.arch }}, built from $PRNUMBER
          at commit $HEAD_ID, against $BRANCH at commit $BASE_ID.

          Package count: ${#IPKS[@]}
          Package size summary:
          EOF
          
          for f in "${IPKS[@]}"; do
            du -sh "$f" >> release/${{ matrix.arch }}/PKG-INFO
          done

      - name: Upload built packages
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}-packages
          path: release/${{ matrix.arch }}/
